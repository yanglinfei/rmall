# 支付模块

### 功能介绍

支付宝对接、支付回调、查询支付状态

### 功能特点

- RSA1和RSA验证签名及加解密
- 避免支付宝重复通知和数据校验
- 生成二维码并持久化到图片服务器

### 支付宝扫码支付功能对接

#### 一些重要的官方文档

- 沙箱登录：https://openhome.alipay.com/platform/appDaily.htm 
- 沙箱环境使用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&articleId=105311&docType=1 
- 如何使用沙箱环境：https://support.open.alipay.com/support/hotProblemDetail.htm?spm=a219a.7386793.0.0.uS5uZ6&id=251932&tagId=100248 
- 当面付产品介绍：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&treeId=193&articleId=105072&docType=1 
- 扫码支付接入指引：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.Ia6Wqy&treeId=193&articleId=106078&docType=1 
- 当面付快速接入：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.bROnXf&treeId=193&articleId=105170&docType=1 
- 当面付接入必读：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&treeId=193&articleId=105322&docType=1 
- 当面付进阶功能：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.YFmkxI&treeId=193&articleId=105190&docType=1 
- 当面付异步通知-仅用于扫码支付：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.BykVSR&treeId=193&articleId=103296&docType=1 
- 当面付SDK&DEMO：https://support.open.alipay.com/docs/doc.htm?spm=a219a.7386797.0.0.k0rwWc&treeId=193&articleId=105201&docType=1 
- 服务端SDK：https://doc.open.alipay.com/doc2/detail?treeId=54&articleId=103419&docType=1 
- 生成RSA密钥：https://doc.open.alipay.com/docs/doc.htm?treeId=291&articleId=105971&docType=1 
- 线上创建应用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&articleId=105310&docType=1#s0 

#### 沙箱调试环境

协助开发者进行**接口功能开发**及**主要功能联调的辅助环境**，沙箱环境模拟了开放平台部分产品的主要功能和主要逻辑。 

#### 支付宝扫码支付重要细节

- 主动轮询和回调的区别
- 避免单边账
- 同步请求的加签和验证签名
- 回调的验证（签名、金额、订单号、订单状态、交易状态、商户id）
- 过滤掉重复的通知
- 一定要验证并确保可接受的异步通知是支付宝发出的
- 回调请求的返回

#### 支付宝扫码支付对接技巧

- 回调的测试方法
- 路由器设置开放本地到外网（不推荐）
- 外网远程debug
  - 保证源端代码版本和本地代码保持一致
  - 把开放远程debug的端口加到防火墙配置中
  - 即使关闭开放的debug端口
- 内网穿透（ngrok、natapp、花生壳）
  - 登陆http://natapp.cn
  - 注册账号、选择是否使用付费隧道
  - 设置对外开放端口
  - 下载对应的客户端
  - 加入authtoken参数
  - 进行访问测试

### 数据表设计

| rmall_pay_info  | 类型     |
| --------------- | -------- |
| id              | int      |
| user_id         | int      |
| order_no        | bigint   |
| pay_platform    | int      |
| platform_number | varchar  |
| platform_status | varchar  |
| create_time     | datetime |
| update_time     | datetime |

### 接口设计

/order路径下

1. 订单支付

   /pay.do

   ```java
   ServerResponse pay(HttpSession session, Long orderNo, HttpServletRequest request)
   ```

2. 支付宝回调

   /alipay_callback.do

   ```java
   Object alipayCallback(HttpServletRequest request)
   ```

3. 查询订单支付状态

   /query_order_pay_status.do

   ```java
   ServerResponse<Boolean> queryOrderPayStatus(HttpSession session, Long orderNo)
   ```

